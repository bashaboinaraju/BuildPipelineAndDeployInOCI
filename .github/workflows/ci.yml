name: Build Java App & Deploy to OCI Container Instance

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 1. Checkout source code
      # -------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Setup Java 17
      # -------------------------------------------------
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # -------------------------------------------------
      # 3. Build JAR using Maven
      # -------------------------------------------------
      - name: Build JAR
        run: mvn clean package

      # -------------------------------------------------
      # 4. Login to OCI Container Registry (OCIR)
      # -------------------------------------------------
      - name: Login to OCIR
        run: |
          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
            ${{ secrets.OCI_REGION }}.ocir.io \
            -u "${{ secrets.OCI_TENANCY_NAMESPACE }}/${{ secrets.OCI_USERNAME }}" \
            --password-stdin

      # -------------------------------------------------
      # 5. Build Docker Image
      # -------------------------------------------------
      - name: Build Docker image
        run: |
          docker build -t \
            ${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_TENANCY_NAMESPACE }}/pipeline:latest .

      # -------------------------------------------------
      # 6. Push Docker Image to OCIR
      # -------------------------------------------------
      - name: Push Docker image
        run: |
          docker push \
            ${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_TENANCY_NAMESPACE }}/pipeline:latest

      # -------------------------------------------------
      # 7. Install OCI CLI
      # -------------------------------------------------
      - name: Install OCI CLI
        run: |
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH

      # -------------------------------------------------
      # 8. Configure OCI CLI
      # -------------------------------------------------
      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_API_KEY_PRIVATE }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_API_KEY_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF

      # -------------------------------------------------
      # 9. Prepare VNIC configuration
      # -------------------------------------------------
      - name: Create vnics.json
        run: |
          cat > vnics.json <<EOF
          [
            {
              "subnetId": "${{ secrets.OCI_SUBNET_OCID }}",
              "assignPublicIp": true
            }
          ]
          EOF

      # -------------------------------------------------
      # 10. Prepare container configuration
      # -------------------------------------------------
      - name: Create containers.json
        run: |
          cat > containers.json <<EOF
          [
            {
              "displayName": "pipeline",
              "imageUrl": "${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_TENANCY_NAMESPACE }}/pipeline:latest",
              "restartPolicy": "ALWAYS"
            }
          ]
          EOF

      # -------------------------------------------------
      # 11. Delete old container instance (if exists)
      # -------------------------------------------------
      - name: Delete existing container instance
        continue-on-error: true
        run: |
          oci container-instances container-instance delete \
            --container-instance-id ${{ secrets.OCI_CONTAINER_INSTANCE_OCID }} \
            --force

      # -------------------------------------------------
      # 12. Create new Container Instance (DEPLOYMENT)
      # -------------------------------------------------
      - name: Create container instance
        run: |
          oci container-instances container-instance create \
            --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
            --display-name pipeline-container-instance \
            --shape CI.Standard.E4.Flex \
            --shape-config '{"ocpus": 1, "memoryInGBs": 2}' \
            --availability-domain QLRk:AP-HYDERABAD-1-AD-1 \
            --vnics file://vnics.json \
            --containers file://containers.json
