name: Build Java App, Push Docker Image to OCIR and Deploy to OCI Container Instance

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING: "True"
      SUPPRESS_LABEL_WARNING: "True"

    steps:
      # --------------------------------
      # 1. Checkout source code
      # --------------------------------
      - name: Checkout source
        uses: actions/checkout@v4

      # --------------------------------
      # 2. Setup Java 17
      # --------------------------------
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # --------------------------------
      # 3. Build executable JAR
      # --------------------------------
      - name: Build JAR
        run: mvn clean package

      # --------------------------------
      # 4. Login to OCI Container Registry (OCIR)
      # --------------------------------
      - name: Login to OCIR
        run: |
          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
          ${{ secrets.OCI_REGION }}.ocir.io \
          -u "${{ secrets.OCI_TENANCY_NAMESPACE }}/${{ secrets.OCI_USERNAME }}" \
          --password-stdin

      # --------------------------------
      # 5. Build Docker image
      # --------------------------------
      - name: Build Docker Image
        run: |
          docker build -t \
          ${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_TENANCY_NAMESPACE }}/pipeline:latest .

      # -------------------------------
      # 6. Push Docker image to OCIR
      # --------------------------------
      - name: Push Docker Image
        run: |
          docker push \
          ${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_TENANCY_NAMESPACE }}/pipeline:latest

      # --------------------------------
      # 7. Install OCI CLI
      # --------------------------------
      - name: Install OCI CLI
        run: |
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh \
          | bash -s -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH

      # --------------------------------
      # 8. Configure OCI CLI (CRITICAL FIX)
      # --------------------------------
      - name: Configure OCI CLI
        run: |
          mkdir -p /home/runner/.oci

          echo "${{ secrets.OCI_CONFIG }}" > /home/runner/.oci/config
          echo "${{ secrets.OCI_API_KEY }}" > /home/runner/.oci/oci_api_key.pem

          chmod 600 /home/runner/.oci/oci_api_key.pem

      # --------------------------------
      # 9. Verify OCI CLI authentication
      # --------------------------------
      - name: Verify OCI CLI
        run: |
          oci iam region list

      # --------------------------------
      # 10. Delete existing Container Instance (OPTIONAL)
      # --------------------------------
      - name: Delete existing Container Instance
        continue-on-error: true
        run: |
          oci container-instances container-instance delete \
            --container-instance-id ${{ secrets.CONTAINER_INSTANCE_OCID }} \
            --force

      # --------------------------------
      # 11. Create OCI Container Instance (JSON FIX APPLIED)
      # --------------------------------
      - name: Create Container Instance
        run: |
          cat > vnics.json <<EOF
          [
            {
              "subnetId": "${{ secrets.OCI_SUBNET_OCID }}",
              "assignPublicIp": true
            }
          ]
          EOF

          cat > containers.json <<EOF
          [
            {
              "displayName": "pipeline",
              "imageUrl": "${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_TENANCY_NAMESPACE }}/pipeline:latest",
              "restartPolicy": "ALWAYS"
            }
          ]
          EOF

          oci container-instances container-instance create \
            --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
            --display-name pipeline-container-instance \
            --shape CI.Standard.E4.Flex \
            --shape-config '{"ocpus": 0.25, "memoryInGBs": 1}' \
            --vnics file://vnics.json \
            --containers file://containers.json
